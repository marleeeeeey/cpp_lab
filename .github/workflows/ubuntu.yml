name: Ubuntu

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:


  emscripten:

    runs-on: ubuntu-latest

    steps:

      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Install emscripten
        uses: mymindstorm/setup-emsdk@6ab9eb1bda2574c4ddb79809fc9247783eaf9021 # v14

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: recursive

      - name: Build host flatc (matches FlatBuffers headers version)
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential
          git clone --depth 1 --branch v25.12.19 https://github.com/google/flatbuffers.git flatbuffers_host
          cmake -S flatbuffers_host -B flatbuffers_host/build -G Ninja \
            -DFLATBUFFERS_BUILD_TESTS=OFF \
            -DFLATBUFFERS_BUILD_FLATC=ON
          cmake --build flatbuffers_host/build --target flatc
          echo "FLATC_HOST_EXECUTABLE=$PWD/flatbuffers_host/build/flatc" >> $GITHUB_ENV

      - name: Get latest CMake and ninja
        uses: lukka/get-cmake@9e07ecdcee1b12e5037e42f410b67f03e2f626e1 # v4.2.1

      - name: Run CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_TOOLCHAIN_FILE=$EMSDK/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake \
            -GNinja \
            -D3RD_PARTY_BUILD_EXAMPLES=OFF \
            -DFLATC_HOST_EXECUTABLE="${{ env.FLATC_HOST_EXECUTABLE }}"

      - name: Build
        run: cmake --build build



  gcc:
    runs-on: ubuntu-latest

    container: gcc:latest

    steps:

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: recursive

      - name: Install OpenSSL
        run: |
          apt-get update
          apt-get install -y libssl-dev openssl

      - name: Get latest CMake and ninja
        uses: lukka/get-cmake@9e07ecdcee1b12e5037e42f410b67f03e2f626e1 # v4.2.1

      - name: Run CMake
        run: cmake -S . -B build -D3RD_PARTY_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build

      - uses: ./.github/actions/deploy_service
        with:
          ssh_host: ${{ secrets.VPS_SSH_HOST }}
          ssh_user: ${{ secrets.VPS_SSH_USER }}
          ssh_key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          ssh_port: ${{ secrets.VPS_SSH_PORT }}

          service_name: ws_echo3
          service_dir: /opt/ws_echo3
          service_source: build/web_sockets_echo_server_no_ssl/web_sockets_echo_server_no_ssl
          service_args: --port 8083

