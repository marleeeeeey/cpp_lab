name: Ubuntu

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:


  emscripten:

    runs-on: ubuntu-latest

    steps:

      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Install emscripten
        uses: mymindstorm/setup-emsdk@6ab9eb1bda2574c4ddb79809fc9247783eaf9021 # v14

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: recursive

      - name: Build host flatc (matches FlatBuffers headers version)
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential
          git clone --depth 1 --branch v25.12.19 https://github.com/google/flatbuffers.git flatbuffers_host
          cmake -S flatbuffers_host -B flatbuffers_host/build -G Ninja \
            -DFLATBUFFERS_BUILD_TESTS=OFF \
            -DFLATBUFFERS_BUILD_FLATC=ON
          cmake --build flatbuffers_host/build --target flatc
          echo "FLATC_HOST_EXECUTABLE=$PWD/flatbuffers_host/build/flatc" >> $GITHUB_ENV

      - name: Get latest CMake and ninja
        uses: lukka/get-cmake@9e07ecdcee1b12e5037e42f410b67f03e2f626e1 # v4.2.1

      - name: Run CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_TOOLCHAIN_FILE=$EMSDK/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake \
            -GNinja \
            -D3RD_PARTY_BUILD_EXAMPLES=OFF \
            -DFLATC_HOST_EXECUTABLE="${{ env.FLATC_HOST_EXECUTABLE }}"

      - name: Build
        run: cmake --build build



  gcc:
    runs-on: ubuntu-latest

    container: gcc:latest

    env:
      SERVICE_NAME: my_server
      BIN_REAL_NAME: build/web_sockets_echo_server_no_ssl/web_sockets_echo_server_no_ssl
      DEPLOY_DIR: /opt/my_server
      PORT: 8080

    steps:

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: recursive

      - name: Install OpenSSL
        run: |
          apt-get update
          apt-get install -y libssl-dev openssl

      - name: Get latest CMake and ninja
        uses: lukka/get-cmake@9e07ecdcee1b12e5037e42f410b67f03e2f626e1 # v4.2.1

      - name: Run CMake
        run: cmake -S . -B build -D3RD_PARTY_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build

      - name: Pack artifact
        run: |
          mkdir -p dist
          cp ${BIN_REAL_NAME} dist/${SERVICE_NAME}
          chmod +x dist/${SERVICE_NAME}

      - name: Upload artifacts to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          source: "dist/*"
          target: "${{ env.DEPLOY_DIR }}"
          rm: false
          overwrite: true

      - name: Restart server via systemd
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            set -e
            cd ${{ env.DEPLOY_DIR }}
            chmod +x ${SERVICE_NAME}
            sudo systemctl restart ${SERVICE_NAME}
            sudo systemctl status ${SERVICE_NAME} --no-pager