name: Ubuntu

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:


  emscripten:

    runs-on: ubuntu-latest

    steps:

      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Install emscripten
        uses: mymindstorm/setup-emsdk@6ab9eb1bda2574c4ddb79809fc9247783eaf9021 # v14

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: recursive

      - name: Build host flatc (matches FlatBuffers headers version)
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential
          git clone --depth 1 --branch v25.12.19 https://github.com/google/flatbuffers.git flatbuffers_host
          cmake -S flatbuffers_host -B flatbuffers_host/build -G Ninja \
            -DFLATBUFFERS_BUILD_TESTS=OFF \
            -DFLATBUFFERS_BUILD_FLATC=ON
          cmake --build flatbuffers_host/build --target flatc
          echo "FLATC_HOST_EXECUTABLE=$PWD/flatbuffers_host/build/flatc" >> $GITHUB_ENV

      - name: Get latest CMake and ninja
        uses: lukka/get-cmake@9e07ecdcee1b12e5037e42f410b67f03e2f626e1 # v4.2.1

      - name: Run CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_TOOLCHAIN_FILE=$EMSDK/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake \
            -GNinja \
            -D3RD_PARTY_BUILD_EXAMPLES=OFF \
            -DFLATC_HOST_EXECUTABLE="${{ env.FLATC_HOST_EXECUTABLE }}"

      - name: Build
        run: cmake --build build



  gcc:
    runs-on: ubuntu-latest

    container: gcc:latest

    env:
      SERVICE_NAME: ws_echo2
      SERVICE_DIR: /opt/ws_echo2
      SERVICE_SOURCE: build/web_sockets_echo_server_no_ssl/web_sockets_echo_server_no_ssl
      SERVICE_PORT: 8082

    steps:

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: recursive

      - name: Install OpenSSL
        run: |
          apt-get update
          apt-get install -y libssl-dev openssl

      - name: Get latest CMake and ninja
        uses: lukka/get-cmake@9e07ecdcee1b12e5037e42f410b67f03e2f626e1 # v4.2.1

      - name: Run CMake
        run: cmake -S . -B build -D3RD_PARTY_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build

      - name: Pack artifact
        run: |
          cp ${SERVICE_SOURCE} ${SERVICE_NAME} # result: buildname -> servicename
          chmod +x ${SERVICE_NAME}

      - name: Create service directories on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            set -e            
            
            # Ensure service working directory exists
            sudo mkdir -p /opt/${{ env.SERVICE_NAME }}
            sudo chown ${{ secrets.VPS_SSH_USER }}:${{ secrets.VPS_SSH_USER }} /opt/${{ env.SERVICE_NAME }}
            sudo chmod 755 /opt/${{ env.SERVICE_NAME }}
            
            # Ensure logs directory exists
            sudo mkdir -p /var/log/${{ env.SERVICE_NAME }}
            sudo chown ${{ secrets.VPS_SSH_USER }}:${{ secrets.VPS_SSH_USER }} /var/log/${{ env.SERVICE_NAME }}

      - name: Upload artifacts to server
        uses: appleboy/scp-action@917f8b81dfc1ccd331fef9e2d61bdc6c8be94634 # v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          source: "${{ env.SERVICE_NAME }}" # scp file list - only file in my case
          target: "${{ env.SERVICE_DIR }}" # target directory on the server
          rm: false # Remove the target directory before upload
          overwrite: true # Overwrite existing files

      - name: Restart server via systemd
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            set -e            
            
            # Create/update systemd unit before restart
            sudo tee /etc/systemd/system/${{ env.SERVICE_NAME }}.service > /dev/null <<'EOF'
            [Unit]
            Description=My Server
            After=network-online.target
            Wants=network-online.target

            [Service]
            Type=simple
            User=${{ secrets.VPS_SSH_USER }}
            WorkingDirectory=${{ env.SERVICE_DIR }}
            ExecStart=${{ env.SERVICE_DIR }}/${{ env.SERVICE_NAME }} --port ${{ env.SERVICE_PORT }}
            Restart=always
            RestartSec=2
            StandardOutput=append:/var/log/${{ env.SERVICE_NAME }}/stdout.log
            StandardError=append:/var/log/${{ env.SERVICE_NAME }}/stderr.log

            [Install]
            WantedBy=multi-user.target
            EOF
            
            # Restart service and check status
            chmod +x ${{ env.SERVICE_DIR }}/${{ env.SERVICE_NAME }}
            sudo systemctl daemon-reload
            sudo systemctl restart ${{ env.SERVICE_NAME }}
            sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager
